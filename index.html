<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D-Star Net Listings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            margin: 20px auto;
            max-width: 100%;
        }
        table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 8px;
            border: 1px solid #ddd;
            word-wrap: break-word;
        }
        th {
            background-color: #f4f4f4;
        }
        th.day, td.day {
            width: 50px;
            text-align: center;
        }
        th.wide, td.wide {
            width: auto;
        }
        .clock {
            text-align: right;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        .filter-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .filter-box select, .filter-box input {
            flex: 1;
        }
        @media (max-width: 768px) {
            th, td {
                font-size: 0.9em;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        // Function to update the clock every second
        function updateClock() {
            const now = new Date();
            const utcHours = now.getUTCHours();
            const utcMinutes = now.getUTCMinutes();
            const utcSeconds = now.getUTCSeconds();
            // Format the time as HH:MM:SS UTC
            const formattedTime = `${utcHours.toString().padStart(2, '0')}:${utcMinutes.toString().padStart(2, '0')}:${utcSeconds.toString().padStart(2, '0')} UTC`;
            document.getElementById("utcClock").textContent = formattedTime;
        }
        // Call updateClock every 1000ms (1 second)
        setInterval(updateClock, 1000);

        // Function to load CSV data from the provided URL using PapaParse
        function loadCSVData() {
            console.log("Loading CSV data from URL: https://raw.githubusercontent.com/sonyccd/d-star-net-list/refs/heads/main/d-star-net-schedule.csv");
            const csvUrl = 'https://raw.githubusercontent.com/sonyccd/d-star-net-list/refs/heads/main/d-star-net-schedule.csv';
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log("CSV data loaded successfully.", results);
                    try {
                        if (!results.data || results.errors.length > 0) {
                            console.error("Errors during CSV parsing:", results.errors);
                            results.errors.forEach((error) => {
                                console.error(`Row ${error.row}: ${error.message}`);
                            });
                            throw new Error("Error parsing CSV file. Please check the file format and content.");
                        }
                        // Once the CSV is parsed, populate the table with the data
                        populateTable(results.data);
                    } catch (error) {
                        console.error("Failed to load CSV data:", error);
                        alert("Failed to load CSV data. Error: " + error.message + "\nPlease check the console for more details.");
                    }
                },
                error: function(error) {
                    console.error("Error fetching CSV file:", error);
                    alert("Failed to load CSV file. Error: " + error.message + "\nPlease check the console for more details.");
                }
            });
        }

        // Function to populate the HTML table with the parsed CSV data
        function populateTable(data) {
            console.log("Populating table with data.", data);
            const tableBody = document.getElementById("netTableBody");
            tableBody.innerHTML = ""; // Clear any existing rows
            // Iterate over each row of data and create table rows dynamically
            try {
                data.forEach((row, index) => {
                    // Skip rows with missing critical fields (e.g., Net name or UTC)
                    if (!row["Net name"] || !row["UTC"]) {
                        console.warn(`Skipping row ${index + 1} due to missing critical fields.`, row);
                        return;
                    }
                    console.log(`Processing row ${index + 1}:`, row);
                    const tableRow = document.createElement("tr");
                    tableRow.innerHTML = `
                        <td class='wide'>${row["Net name"] || ''}</td>
                        <td class='day'>${row["Mo"] === 'x' ? '✔' : ''}</td>
                        <td class='day'>${row["Tu"] === 'x' ? '✔' : ''}</td>
                        <td class='day'>${row["We"] === 'x' ? '✔' : ''}</td>
                        <td class='day'>${row["Th"] === 'x' ? '✔' : ''}</td>
                        <td class='day'>${row["Fr"] === 'x' ? '✔' : ''}</td>
                        <td class='day'>${row["Sa"] === 'x' ? '✔' : ''}</td>
                        <td class='day'>${row["Su"] === 'x' ? '✔' : ''}</td>
                        <td class='wide'>${row["UTC"] || ''}</td>
                        <td class='wide'>${row["Mode"] || ''}</td>
                        <td class='wide'>${row["Node"] || ''}</td>
                        <td class='wide'>${row["Comment"] || ''}</td>
                    `;
                    tableBody.appendChild(tableRow); // Append the new row to the table body
                });
                console.log("Table populated successfully.");
            } catch (error) {
                console.error("Error populating table:", error);
                alert("An error occurred while populating the table. Error: " + error.message + "\nPlease check the console for more details.");
            }
        }

        // Function to filter the table based on user input
        function filterTable() {
            console.log("Filtering table...");
            const nameInput = document.getElementById("nameFilter").value.toUpperCase(); // Get the filter value for name
            const dayFilter = document.getElementById("dayFilter").value; // Get the selected day to filter by
            const table = document.getElementById("netTable");
            const rows = table.getElementsByTagName("tr");

            // Iterate over all rows, starting from index 1 to skip the header row
            try {
                for (let i = 1; i < rows.length; i++) {
                    const nameCell = rows[i].getElementsByTagName("td")[0]; // Net Name column
                    const nameMatch = nameCell && nameCell.textContent.toUpperCase().includes(nameInput); // Check if name matches filter

                    // Get the day index based on the selected day filter (if any)
                    const dayIndex = {"Monday": 1, "Tuesday": 2, "Wednesday": 3, "Thursday": 4, "Friday": 5, "Saturday": 6, "Sunday": 7}[dayFilter];
                    const dayCell = dayFilter && rows[i].getElementsByTagName("td")[dayIndex]; // Get the cell for the selected day
                    const dayMatch = !dayFilter || (dayCell && dayCell.textContent === "✔"); // Check if day matches filter

                    // Show or hide the row based on the filter matches
                    rows[i].style.display = nameMatch && dayMatch ? "" : "none";
                    console.log(`Row ${i}: nameMatch=${nameMatch}, dayMatch=${dayMatch}, display=${rows[i].style.display}`);
                }
                console.log("Table filtering completed.");
            } catch (error) {
                console.error("Error filtering table:", error);
                alert("An error occurred while filtering the table. Error: " + error.message + "\nPlease check the console for more details.");
            }
        }

        // Load the CSV data when the document content is fully loaded
        document.addEventListener("DOMContentLoaded", loadCSVData);
    </script>
</head>
<body onload="updateClock()">
    <div class="container mt-5">
        <div class="clock">
            Current Time: <span id="utcClock"></span>
        </div>
        <h1 class="mb-4">D-Star Net Listings (UTC)</h1>
        <h3 class="mb-4">Built from N5VLZ's great spreadsheet</h3>
        <div class="filter-box">
            <input type="text" id="nameFilter" onkeyup="filterTable()" class="form-control" placeholder="Filter by name...">
            <select id="dayFilter" onchange="filterTable()" class="form-control">
                <option value="">Filter by day</option>
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
            </select>
        </div>
        <div class="table-responsive">
            <table id="netTable" class="table table-bordered table-striped">
                <thead>
                    <tr><th class='wide'>Net Name</th><th class='day'>Monday</th><th class='day'>Tuesday</th><th class='day'>Wednesday</th><th class='day'>Thursday</th><th class='day'>Friday</th><th class='day'>Saturday</th><th class='day'>Sunday</th><th class='wide'>UTC Time</th><th class='wide'>Mode</th><th class='wide'>Node</th><th class='wide'>Comment</th></tr>
                </thead>
                <tbody id="netTableBody">
                    <!-- Data will be populated here dynamically from CSV -->
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>
